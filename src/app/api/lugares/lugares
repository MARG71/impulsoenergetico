// âœ… src/app/api/lugares/route.ts
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getTenantContext } from "@/lib/tenant";

// Helpers porcentajes
function toPct(value: any): number | null {
  if (value === null || value === undefined || value === "") return null;
  const n = Number(String(value).replace(",", "."));
  if (Number.isNaN(n)) return null;
  // Si viene 15 => 0.15
  return n > 1 ? n / 100 : n;
}

function toIntOrNull(v: any): number | null {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GET /api/lugares
//  - SUPERADMIN global: ve todos (salvo ocultos), salvo que pase ?adminId
//  - SUPERADMIN en tenant (?adminId): ve solo los del admin
//  - ADMIN: ve solo sus lugares
//  - AGENTE: ve solo sus lugares
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function GET(req: NextRequest) {
  const ctx = await getTenantContext(req);
  if (!ctx.ok) {
    return NextResponse.json({ error: "No autorizado" }, { status: 401 });
  }

  const {
    isSuperadmin,
    isAdmin,
    isAgente,
    isLugar,
    tenantAdminId,
    agenteId,
    lugarId,
  } = ctx;

  // Opciones de filtro (por si en el futuro quieres ver ocultos, etc.)
  const url = req.nextUrl;
  const modo = url.searchParams.get("modo"); // "soloOcultos" | "todos"
  const incluirOcultos = url.searchParams.get("incluirOcultos") === "1";

  const where: any = {};

  // Por defecto NO mostramos ocultos
  if (modo === "soloOcultos") {
    where.ocultoParaAdmin = true;
  } else if (!incluirOcultos) {
    where.ocultoParaAdmin = false;
  }

  if (isSuperadmin) {
    // Global o por tenant
    if (tenantAdminId) {
      where.adminId = tenantAdminId;
    }
  } else if (isAdmin) {
    if (!tenantAdminId) {
      return NextResponse.json(
        { error: "Config de tenant invÃ¡lida para ADMIN (sin tenantAdminId)" },
        { status: 400 }
      );
    }
    where.adminId = tenantAdminId;
  } else if (isAgente) {
    if (!agenteId) {
      return NextResponse.json(
        { error: "Este usuario no tiene agenteId asociado" },
        { status: 400 }
      );
    }
    where.agenteId = agenteId;
    if (tenantAdminId) {
      where.adminId = tenantAdminId;
    }
  } else if (isLugar) {
    // Un usuario LUGAR no deberÃ­a usar este endpoint, pero por si acaso:
    if (!lugarId) {
      return NextResponse.json(
        { error: "Este usuario LUGAR no tiene lugarId asociado" },
        { status: 400 }
      );
    }
    where.id = lugarId;
  } else {
    return NextResponse.json(
      { error: "Rol no autorizado para ver lugares" },
      { status: 403 }
    );
  }

  const lugares = await prisma.lugar.findMany({
    where,
    orderBy: { id: "asc" },
    include: {
      agente: {
        select: { id: true, nombre: true, email: true, telefono: true },
      },
    },
  });

  return NextResponse.json(lugares);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POST /api/lugares
//
//  SUPERADMIN:
//   - si estÃ¡ en modo tenant (?adminId=...), se usa ese adminId
//   - si NO estÃ¡ en modo tenant, se usa body.adminSeleccionado
//   - si no hay ninguno de los dos â†’ error
//
//  ADMIN: crea siempre para su propio tenant
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function POST(req: NextRequest) {
  const ctx = await getTenantContext(req);
  if (!ctx.ok) {
    return NextResponse.json({ error: "No autorizado" }, { status: 401 });
  }

  const { isSuperadmin, isAdmin, isAgente, tenantAdminId, userId } = ctx;

  // Solo SUPERADMIN, ADMIN o (si quieres en el futuro) AGENTE pueden crear
  if (!isSuperadmin && !isAdmin && !isAgente) {
    return NextResponse.json(
      { error: "Solo SUPERADMIN, ADMIN o AGENTE pueden crear lugares" },
      { status: 403 }
    );
  }

  const body = (await req.json().catch(() => ({}))) as any;

  const {
    nombre,
    direccion,
    qrCode,
    agenteId,
    pctCliente,
    pctLugar,
    especial,
    especialLogoUrl,
    especialColor,
    especialMensaje,
    aportacionAcumulada,
    especialCartelUrl,
    // ðŸ‘‡ viene del formulario cuando estÃ¡s en SUPERADMIN
    adminSeleccionado,
  } = body || {};

  if (!nombre || !direccion || !qrCode || !agenteId) {
    return NextResponse.json(
      { error: "Nombre, direcciÃ³n, QR y agente son obligatorios" },
      { status: 400 }
    );
  }

  // â”€â”€ Determinar adminId (tenant dueÃ±o del lugar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let adminId: number | null = null;

  if (isSuperadmin) {
    // 1) si estÃ¡ en modo tenant, prima ese
    if (tenantAdminId) {
      adminId = tenantAdminId;
    } else {
      // 2) si NO estÃ¡ en modo tenant, usamos el adminSeleccionado del body
      const adminSelNum = toIntOrNull(adminSeleccionado);
      if (!adminSelNum) {
        return NextResponse.json(
          {
            error:
              "SUPERADMIN debe indicar ?adminId=â€¦ o seleccionar un administrador en el desplegable para crear lugares dentro de un tenant",
          },
          { status: 400 }
        );
      }
      adminId = adminSelNum;
    }
  } else if (isAdmin) {
    // Para ADMIN, el tenant es Ã©l mismo (o el tenantAdminId)
    adminId = tenantAdminId ?? toIntOrNull(userId) ?? null;
  } else if (isAgente) {
    // Para AGENTE, el adminId es el dueÃ±o del agente (tenantAdminId)
    adminId = tenantAdminId ?? null;
  }

  // â”€â”€ Validaciones bÃ¡sicas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const agenteIdNum = Number(agenteId);
  if (!Number.isFinite(agenteIdNum)) {
    return NextResponse.json(
      { error: "agenteId invÃ¡lido" },
      { status: 400 }
    );
  }

  // Opcional: comprobar que el agente pertenece a ese admin (si adminId estÃ¡ definido)
  if (adminId) {
    const agente = await prisma.agente.findUnique({
      where: { id: agenteIdNum },
      select: { id: true, adminId: true },
    });

    if (!agente) {
      return NextResponse.json(
        { error: "Agente no encontrado" },
        { status: 400 }
      );
    }

    if (agente.adminId && agente.adminId !== adminId) {
      return NextResponse.json(
        {
          error:
            "El agente seleccionado no pertenece al administrador indicado",
        },
        { status: 400 }
      );
    }
  }

  // â”€â”€ Crear lugar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const nuevoLugar = await prisma.lugar.create({
    data: {
      nombre: String(nombre).trim(),
      direccion: String(direccion).trim(),
      qrCode: String(qrCode).trim(),
      agenteId: agenteIdNum,

      pctCliente: toPct(pctCliente),
      pctLugar: toPct(pctLugar),

      especial: !!especial,
      especialLogoUrl: especial ? especialLogoUrl || null : null,
      especialColor: especial ? especialColor || null : null,
      especialMensaje: especial ? especialMensaje || null : null,

      aportacionAcumulada: Number.isFinite(Number(aportacionAcumulada))
        ? Number(aportacionAcumulada)
        : 0,

      especialCartelUrl: especial && especialCartelUrl
        ? String(especialCartelUrl)
        : null,

      adminId: adminId ?? undefined,
    },
    include: {
      agente: {
        select: { id: true, nombre: true, email: true, telefono: true },
      },
    },
  });

  return NextResponse.json(nuevoLugar);
}
