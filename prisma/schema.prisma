generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  SUPERADMIN
  ADMIN
  AGENTE
  LUGAR
}


model Cliente {
  id           Int           @id @default(autoincrement())
  nombre       String
  direccion    String
  email        String?       @unique
  telefono     String?
  comparativas Comparativa[]
  contratos    Contrato[]
}

model Comparativa {
  id             Int      @id @default(autoincrement())
  clienteId      Int
  tipoServicio   String
  tipoTarifa     String
  nombreTarifa   String
  consumoAnual   Float
  importeFactura Float
  ahorro         Float    @default(0)
  comision       Float    @default(0)
  fecha          DateTime @default(now())
  agenteId       Int
  lugarId        Int

  // ✅ SOLAR / EXCEDENTE
  tieneSolar        Boolean @default(false)
  excedenteAnualKwh Float?
  excedenteTarifaId Int?

  // Snapshots opcionales (recomendado para mantener histórico coherente)
  excedentePrecioKwhSnap Decimal? @db.Decimal(10, 6)
  excedenteTipoSnap      String?

  cliente      Cliente                @relation(fields: [clienteId], references: [id])
  agente       Agente                 @relation(fields: [agenteId], references: [id])
  lugar        Lugar                  @relation(fields: [lugarId], references: [id])
  datosFactura DatosFactura?
  resultados   ResultadoComparativa[]

  // ✅ relación a catálogo de excedentes
  excedenteTarifa SolarExcedenteTarifa? @relation(fields: [excedenteTarifaId], references: [id])

  @@index([tieneSolar])
  @@index([excedenteTarifaId])
}

model ResultadoComparativa {
  id             Int    @id @default(autoincrement())
  comparativaId  Int
  compañia      String
  tarifa         String
  precioAnual    Float
  ahorroEstimado Float

  comparativa Comparativa @relation(fields: [comparativaId], references: [id])
}

model Contrato {
  id        Int      @id @default(autoincrement())
  clienteId Int
  servicio  String
  compañia String
  tarifa    String
  fechaAlta DateTime @default(now())
  comision  Float
  agenteId  Int?

  cliente Cliente @relation(fields: [clienteId], references: [id])
  agente  Agente? @relation(fields: [agenteId], references: [id])
}

model Agente {
  id       Int     @id @default(autoincrement())
  nombre   String
  email    String  @unique
  telefono String?

  // % del REMANENTE para el Agente (0..1). Si es null, se usan defaults/overrides.
  pctAgente Decimal? @db.Decimal(5, 4)

  contratos    Contrato[]
  lugares      Lugar[]
  comparativas Comparativa[]
  qrs          QR[]
  leads        Lead[]
  usuarios     Usuario[]
  overrides    ComisionOverride[]

  creadoEn DateTime @default(now())
}

model Lugar {
  id        Int    @id @default(autoincrement())
  nombre    String
  direccion String
  qrCode    String @unique
  agenteId  Int

  // % del POOL para el Cliente (0..1). Si es null, se usan defaults/overrides.
  pctCliente Decimal? @db.Decimal(5, 4)
  // % del REMANENTE para el Lugar (0..1). Si es null, se usan defaults/overrides.
  pctLugar   Decimal? @db.Decimal(5, 4)

  agente       Agente             @relation(fields: [agenteId], references: [id])
  comparativas Comparativa[]
  qrs          QR[]
  leads        Lead[]
  usuarios     Usuario[]
  overrides    ComisionOverride[]

  creadoEn DateTime @default(now())

  // --- Personalización landing ---
  especial        Boolean @default(false)
  especialLogoUrl String?
  especialColor   String?
  especialMensaje String?

  // --- Métrica para el contador de la landing ---
  aportacionAcumulada Int @default(0) // en euros

  // NUEVO: cartel individual para lugares especiales
  especialCartelUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) // <- PASO 1: poner default inicial (SIN @updatedAt aún)
}

model QR {
  id       Int    @id @default(autoincrement())
  codigo   String @unique
  lugarId  Int
  agenteId Int?

  lugar  Lugar   @relation(fields: [lugarId], references: [id])
  agente Agente? @relation(fields: [agenteId], references: [id])
}

model Usuario {
  id       Int    @id @default(autoincrement())
  nombre   String
  email    String @unique
  password String
  rol      Rol    @default(LUGAR)
  agenteId Int?
  lugarId  Int?

  agente Agente? @relation(fields: [agenteId], references: [id])
  lugar  Lugar?  @relation(fields: [lugarId], references: [id])
}

model Lead {
  id       Int      @id @default(autoincrement())
  nombre   String
  email    String
  telefono String
  estado   String   @default("pendiente")
  creadoEn DateTime @default(now())

  lugarId Int?
  lugar   Lugar? @relation(fields: [lugarId], references: [id])

  agenteId Int?
  agente   Agente? @relation(fields: [agenteId], references: [id])
}

model DatosFactura {
  id                   Int         @id @default(autoincrement())
  tipoCliente          String?
  tipoTarifa           String?
  nombreTarifa         String?
  cups                 String?
  fechaInicio          String?
  fechaFin             String?
  consumoPeriodos      String?
  potencias            String?
  consumoAnualKWh      Float?
  importeFactura       Float?
  iva                  Float?
  impuestoElectricidad Float?
  territorio           String?
  reactiva             Float?
  exceso               Float?
  alquiler             Float?
  otros                Float?
  comparativaId        Int         @unique
  comparativa          Comparativa @relation(fields: [comparativaId], references: [id])
}

model FondoCartel {
  id       Int      @id @default(autoincrement())
  nombre   String
  url      String
  creadoEn DateTime @default(now())
  activo   Boolean  @default(false)
}

model FondoActivo {
  id       Int      @id @default(1)
  url      String
  creadoEn DateTime @default(now())
}

model Fondo {
  id       Int      @id @default(autoincrement())
  nombre   String
  url      String   @unique
  creadoEn DateTime @default(now())
  activo   Boolean  @default(false)
}

model ConfiguracionGlobal {
  id             Int    @id @default(1)
  fondoCartelUrl String
}

// ======================
// Ofertas (marketing)
// ======================
model Oferta {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  descripcionCorta String?
  tipo             String // 'luz' | 'gas' | 'telefonia'
  destacada        Boolean  @default(false)
  activa           Boolean  @default(true)
  creadaEn         DateTime @default(now())

  // Enlace opcional al catálogo (si esta oferta nace de una tarifa)
  ofertaTarifaId Int?
  ofertaTarifa   OfertaTarifa? @relation("TarifaAOferta", fields: [ofertaTarifaId], references: [id])

  @@index([ofertaTarifaId])
}

model ProductoGanadero {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String
  categoria   String
  precioCoste Float
  margen      Float
  precioPVP   Float
  descuento   Float?
  precioFinal Float
  imagenUrl   String
  activo      Boolean  @default(true)
  creadoEn    DateTime @default(now())
}

/**
 * =========
 * COMISIONES
 * =========
 */

model GlobalComisionDefaults {
  id                Int      @id @default(1)
  defaultPctCliente Decimal  @db.Decimal(5, 4)
  defaultPctLugar   Decimal  @db.Decimal(5, 4)
  defaultPctAgente  Decimal  @db.Decimal(5, 4)
  actualizadoEn     DateTime @updatedAt

  @@map("global_comision_defaults")
}

model ComisionOverride {
  id Int @id @default(autoincrement())

  lugarId Int
  lugar   Lugar @relation(fields: [lugarId], references: [id])

  agenteId Int?
  agente   Agente? @relation(fields: [agenteId], references: [id])

  compania String?
  tarifa   String?

  pctCliente Decimal? @db.Decimal(5, 4)
  pctLugar   Decimal? @db.Decimal(5, 4)
  pctAgente  Decimal? @db.Decimal(5, 4)

  validFrom DateTime?
  validTo   DateTime?
  activo    Boolean   @default(true)
  prioridad Int       @default(0)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@index([lugarId, compania, tarifa, activo, validFrom, validTo])
  @@map("comision_override")
}

// ======================
// Catálogo de tarifas
// ======================
enum TipoOferta {
  LUZ
  GAS
  TELEFONIA
}

enum TipoCliente {
  RESIDENCIAL
  PYME
}

model OfertaTarifa {
  id               Int        @id @default(autoincrement())
  tipo             TipoOferta
  subtipo          String
  compania         String
  anexoPrecio      String?
  nombre           String
  descripcion      String?
  descripcionCorta String?
  activa           Boolean    @default(true)
  destacada        Boolean    @default(false)

  // ENERGÍA (€/kWh)
  precioKwhP1 Decimal? @db.Decimal(10, 6)
  precioKwhP2 Decimal? @db.Decimal(10, 6)
  precioKwhP3 Decimal? @db.Decimal(10, 6)
  precioKwhP4 Decimal? @db.Decimal(10, 6)
  precioKwhP5 Decimal? @db.Decimal(10, 6)
  precioKwhP6 Decimal? @db.Decimal(10, 6)

  // POTENCIA (€/kW·año)
  precioPotenciaP1 Decimal? @db.Decimal(10, 6)
  precioPotenciaP2 Decimal? @db.Decimal(10, 6)
  precioPotenciaP3 Decimal? @db.Decimal(10, 6)
  precioPotenciaP4 Decimal? @db.Decimal(10, 6)
  precioPotenciaP5 Decimal? @db.Decimal(10, 6)
  precioPotenciaP6 Decimal? @db.Decimal(10, 6)

  comisionKwhAdminBase Decimal? @db.Decimal(10, 6)
  payload              Json?

  referencia  String?
  tipoCliente TipoCliente?

  tramos  OfertaTarifaTramo[]
  ofertas Oferta[]            @relation("TarifaAOferta")

  // ✅ NUEVO: configuración solar por tarifa base
  solarConfigBase     OfertaTarifaSolarConfig?  @relation("SolarBase")
  solarConfigEspecial OfertaTarifaSolarConfig[] @relation("SolarEspecial")

  creadaEn      DateTime @default(now())
  actualizadaEn DateTime @updatedAt

  @@unique([tipo, subtipo, compania, nombre, anexoPrecio])
  @@index([tipo, subtipo, compania])
  @@index([tipo, subtipo, anexoPrecio])
}

model OfertaTarifaTramo {
  id             Int @id @default(autoincrement())
  ofertaTarifaId Int

  consumoDesdeKWh Int
  consumoHastaKWh Int?

  comisionKwhAdmin  Decimal? @db.Decimal(10, 6)
  comisionFijaAdmin Decimal? @db.Decimal(10, 2)

  pctCliente Decimal? @db.Decimal(5, 4)
  pctLugar   Decimal? @db.Decimal(5, 4)
  pctAgente  Decimal? @db.Decimal(5, 4)

  validFrom DateTime?
  validTo   DateTime?
  activo    Boolean   @default(true)
  notas     String?

  ofertaTarifa OfertaTarifa @relation(fields: [ofertaTarifaId], references: [id], onDelete: Cascade)

  @@unique([ofertaTarifaId, consumoDesdeKWh, consumoHastaKWh])
  @@index([ofertaTarifaId])
  @@index([consumoDesdeKWh, consumoHastaKWh])
}

model SolicitudContrato {
  id       Int      @id @default(autoincrement())
  creadaEn DateTime @default(now())
  estado   String   @default("PENDIENTE")

  tipoContratacion String?

  nombre              String
  apellidos           String?
  telefono            String
  email               String?
  dni                 String?
  direccionSuministro String?
  cups                String?
  iban                String?

  ofertaId     Int?
  compania     String?
  tarifa       String?
  agenteId     Int?
  lugarId      Int?
  tipoCliente  String?
  nombreTarifa String?

  archivos SolicitudContratoArchivo[]
}

model SolicitudContratoArchivo {
  id       Int      @id @default(autoincrement())
  creadaEn DateTime @default(now())

  solicitudId    Int
  url            String
  publicId       String?
  tipo           String?
  nombreOriginal String?
  mime           String?
  size           Int?

  solicitud SolicitudContrato @relation(fields: [solicitudId], references: [id], onDelete: Cascade)
}

// ======================
// ✅ SOLAR / EXCEDENTES
// ======================
enum TipoCompensacionExcedente {
  COMPENSACION
  BATERIA_VIRTUAL
  OTRO
}

enum LimiteCompensacionExcedente {
  ENERGIA
  TOTAL
}

model SolarExcedenteTarifa {
  id        Int                         @id @default(autoincrement())
  nombre    String
  compania  String?
  tipo      TipoCompensacionExcedente   @default(COMPENSACION)
  limite    LimiteCompensacionExcedente @default(ENERGIA)
  precioKwh Decimal?                    @db.Decimal(10, 6)
  payload   Json?

  activa        Boolean  @default(true)
  creadaEn      DateTime @default(now())
  actualizadaEn DateTime @updatedAt

  comparativas             Comparativa[]
  ofertaTarifaSolarConfigs OfertaTarifaSolarConfig[]

  @@index([activa, tipo])
  @@index([compania])
}

// ======================
// ✅ CONFIG SOLAR POR TARIFA (NUEVO)
// ======================
enum ModoSolarTarifa {
  MISMA_TARIFA
  TARIFA_SOLAR_ESPECIAL
}

model OfertaTarifaSolarConfig {
  id Int @id @default(autoincrement())

  // Tarifa base del catálogo
  ofertaTarifaBaseId Int
  ofertaTarifaBase   OfertaTarifa @relation("SolarBase", fields: [ofertaTarifaBaseId], references: [id], onDelete: Cascade)

  modo ModoSolarTarifa @default(MISMA_TARIFA)

  // Si modo = TARIFA_SOLAR_ESPECIAL, esta apunta a la tarifa/anexo solar específico
  ofertaTarifaSolarId Int?
  ofertaTarifaSolar   OfertaTarifa? @relation("SolarEspecial", fields: [ofertaTarifaSolarId], references: [id])

  // Compensación/pago por excedente (para ambos modos)
  excedenteTarifaId Int?
  excedenteTarifa   SolarExcedenteTarifa? @relation(fields: [excedenteTarifaId], references: [id])

  activa Boolean @default(true)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([ofertaTarifaBaseId])
  @@index([modo, activa])
  @@index([excedenteTarifaId])
}
