generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  SUPERADMIN
  ADMIN
  AGENTE
  LUGAR
  CLIENTE
}

model Cliente {
  id              Int           @id @default(autoincrement())
  nombre          String
  direccion       String
  email           String?       @unique
  telefono        String?
  comparativas    Comparativa[]
  contratos       Contrato[]
  ocultoParaAdmin Boolean       @default(false)

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminClientes", fields: [adminId], references: [id])

  @@index([adminId])
}

model Comparativa {
  id             Int      @id @default(autoincrement())
  clienteId      Int
  tipoServicio   String
  tipoTarifa     String
  nombreTarifa   String
  consumoAnual   Float
  importeFactura Float
  ahorro         Float    @default(0)
  comision       Float    @default(0)
  fecha          DateTime @default(now())
  agenteId       Int
  lugarId        Int

  // ✅ SOLAR / EXCEDENTE
  tieneSolar        Boolean @default(false)
  excedenteAnualKwh Float?
  excedenteTarifaId Int?

  excedentePrecioKwhSnap Decimal? @db.Decimal(10, 6)
  excedenteTipoSnap      String?

  cliente      Cliente                @relation(fields: [clienteId], references: [id])
  agente       Agente                 @relation(fields: [agenteId], references: [id])
  lugar        Lugar                  @relation(fields: [lugarId], references: [id])
  datosFactura DatosFactura?
  resultados   ResultadoComparativa[]

  excedenteTarifa SolarExcedenteTarifa? @relation(fields: [excedenteTarifaId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminComparativas", fields: [adminId], references: [id])

  @@index([tieneSolar])
  @@index([excedenteTarifaId])
  @@index([adminId])
}

model ResultadoComparativa {
  id             Int    @id @default(autoincrement())
  comparativaId  Int
  compañia      String
  tarifa         String
  precioAnual    Float
  ahorroEstimado Float

  comparativa Comparativa @relation(fields: [comparativaId], references: [id])
}

model Contrato {
  id        Int      @id @default(autoincrement())
  clienteId Int
  servicio  String
  compañia String
  tarifa    String
  fechaAlta DateTime @default(now())
  comision  Float
  agenteId  Int?

  cliente Cliente @relation(fields: [clienteId], references: [id])
  agente  Agente? @relation(fields: [agenteId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminContratos", fields: [adminId], references: [id])

  @@index([adminId])
}

model Agente {
  id       Int     @id @default(autoincrement())
  nombre   String
  email    String  @unique
  telefono String?

  pctAgente Decimal? @db.Decimal(5, 4)

  contratos    Contrato[]
  lugares      Lugar[]
  comparativas Comparativa[]
  qrs          QR[]
  leads        Lead[]
  usuarios     Usuario[]
  overrides    ComisionOverride[]

  creadoEn        DateTime @default(now())
  ocultoParaAdmin Boolean  @default(false)

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminAgentes", fields: [adminId], references: [id])

  @@index([adminId])
}

model Lugar {
  id        Int    @id @default(autoincrement())
  nombre    String
  direccion String
  qrCode    String @unique
  agenteId  Int

  pctCliente Decimal? @db.Decimal(5, 4)
  pctLugar   Decimal? @db.Decimal(5, 4)

  agente       Agente             @relation(fields: [agenteId], references: [id])
  comparativas Comparativa[]
  qrs          QR[]
  leads        Lead[]
  usuarios     Usuario[]
  overrides    ComisionOverride[]

  // ✅ AÑADIDO: relación inversa para MarketingAsset (ARREGLA P1012)
  marketingAssets MarketingAsset[]

  creadoEn DateTime @default(now())

  especial        Boolean @default(false)
  especialLogoUrl String?
  especialColor   String?
  especialMensaje String?

  aportacionAcumulada Int @default(0)

  especialCartelUrl String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  ocultoParaAdmin Boolean  @default(false)

  // ✅ MULTI-ADMIN (TENANT)
  adminId           Int?
  admin             Usuario?         @relation("AdminLugares", fields: [adminId], references: [id])
  cartelesGenerados CartelGenerado[] @relation("LugarCartelesGenerados")

  @@index([adminId])
}

model QR {
  id       Int    @id @default(autoincrement())
  codigo   String @unique
  lugarId  Int
  agenteId Int?

  lugar  Lugar   @relation(fields: [lugarId], references: [id])
  agente Agente? @relation(fields: [agenteId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminQRs", fields: [adminId], references: [id])

  @@index([adminId])
}

model Usuario {
  id       Int    @id @default(autoincrement())
  nombre   String
  email    String @unique
  password String
  rol      Rol    @default(LUGAR)

  // relación operativa
  agenteId Int?
  lugarId  Int?

  agente Agente? @relation(fields: [agenteId], references: [id])
  lugar  Lugar?  @relation(fields: [lugarId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId  Int?
  admin    Usuario?  @relation("AdminUsuarios", fields: [adminId], references: [id])
  usuarios Usuario[] @relation("AdminUsuarios")

  // ✅ relaciones “dueño”
  agentesGestionados      Agente[]            @relation("AdminAgentes")
  lugaresGestionados      Lugar[]             @relation("AdminLugares")
  clientesGestionados     Cliente[]           @relation("AdminClientes")
  comparativasGestionadas Comparativa[]       @relation("AdminComparativas")
  leadsGestionados        Lead[]              @relation("AdminLeads")
  qrsGestionados          QR[]                @relation("AdminQRs")
  contratosGestionados    Contrato[]          @relation("AdminContratos")
  ofertasGestionadas      Oferta[]            @relation("AdminOfertas")
  productosGestionados    ProductoGanadero[]  @relation("AdminProductos")
  solicitudesGestionadas  SolicitudContrato[] @relation("AdminSolicitudes")

  leadActividadesCreadas     LeadActividad[] @relation("UsuarioLeadActividades")
  leadActividadesGestionadas LeadActividad[] @relation("AdminLeadActividades")

  cartelesCreados     CartelGenerado[] @relation("UsuarioCartelesCreados")
  cartelesGestionados CartelGenerado[] @relation("AdminCartelesGenerados")

  // ✅ Plantillas / A-B tracking
  plantillaMensajes PlantillaMensaje[] @relation("PlantillaMensajeAdmin")
  plantillaEnvio    PlantillaEnvio[]   @relation("PlantillaEnvioUsuario")
  plantillaEnvios   PlantillaEnvio[]
  
  leadDocumentosCreados LeadDocumento[] @relation("LeadDocumentoCreadoPor")
  leadDocumentosGestionados LeadDocumento[] @relation("LeadDocumentoAdmin")



  @@index([adminId])
}

model Lead {
  id       Int      @id @default(autoincrement())
  nombre   String
  email    String
  telefono String
  estado   String   @default("pendiente")
  creadoEn DateTime @default(now())

  lugarId Int?
  lugar   Lugar? @relation(fields: [lugarId], references: [id])

  agenteId Int?
  agente   Agente? @relation(fields: [agenteId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminLeads", fields: [adminId], references: [id])

  // ✅ GESTIÓN COMERCIAL (AÑADIR)
  notas           String?
  proximaAccion   String?
  proximaAccionEn DateTime?

  // ✅ CONVERSIÓN (para fase 2, pero lo dejamos ya preparado)
  comparativaId Int?
  contratoId    Int?

  actividades     LeadActividad[]
  plantillaEnvios PlantillaEnvio[]

  documentos LeadDocumento[]


  @@index([adminId])
  @@index([estado, creadoEn])
  @@index([proximaAccionEn])
}

model DatosFactura {
  id                   Int         @id @default(autoincrement())
  tipoCliente          String?
  tipoTarifa           String?
  nombreTarifa         String?
  cups                 String?
  fechaInicio          String?
  fechaFin             String?
  consumoPeriodos      String?
  potencias            String?
  consumoAnualKWh      Float?
  importeFactura       Float?
  iva                  Float?
  impuestoElectricidad Float?
  territorio           String?
  reactiva             Float?
  exceso               Float?
  alquiler             Float?
  otros                Float?
  comparativaId        Int         @unique
  comparativa          Comparativa @relation(fields: [comparativaId], references: [id])
}

model FondoCartel {
  id       Int      @id @default(autoincrement())
  nombre   String
  url      String
  creadoEn DateTime @default(now())
  activo   Boolean  @default(false)
}

model FondoActivo {
  id       Int      @id @default(1)
  url      String
  creadoEn DateTime @default(now())
}

model Fondo {
  id       Int      @id @default(autoincrement())
  nombre   String
  url      String   @unique
  creadoEn DateTime @default(now())
  activo   Boolean  @default(false)

  // ✅ Cloudinary metadata (para borrar de Cloudinary y depurar)
  publicId     String? // ej: impulso/fondos/historico/xxxx
  resourceType String? // image | video | raw
  bytes        Int?
  width        Int?
  height       Int?
  format       String?

  // opcional (si quieres conservarlo)
  mime              String?
  cartelesGenerados CartelGenerado[] @relation("FondoCartelesGenerados")
}

model ConfiguracionGlobal {
  id             Int    @id @default(1)
  fondoCartelUrl String
}

model Oferta {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  descripcionCorta String?
  tipo             String
  destacada        Boolean  @default(false)
  activa           Boolean  @default(true)
  creadaEn         DateTime @default(now())

  ofertaTarifaId Int?
  ofertaTarifa   OfertaTarifa? @relation("TarifaAOferta", fields: [ofertaTarifaId], references: [id])

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminOfertas", fields: [adminId], references: [id])

  @@index([ofertaTarifaId])
  @@index([adminId])
}

model ProductoGanadero {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String
  categoria   String
  precioCoste Float
  margen      Float
  precioPVP   Float
  descuento   Float?
  precioFinal Float
  imagenUrl   String
  activo      Boolean  @default(true)
  creadoEn    DateTime @default(now())

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminProductos", fields: [adminId], references: [id])

  @@index([adminId])
}

model GlobalComisionDefaults {
  id                Int      @id @default(1)
  defaultPctCliente Decimal  @db.Decimal(5, 4)
  defaultPctLugar   Decimal  @db.Decimal(5, 4)
  defaultPctAgente  Decimal  @db.Decimal(5, 4)
  actualizadoEn     DateTime @updatedAt

  @@map("global_comision_defaults")
}

model ComisionOverride {
  id Int @id @default(autoincrement())

  lugarId Int
  lugar   Lugar @relation(fields: [lugarId], references: [id])

  agenteId Int?
  agente   Agente? @relation(fields: [agenteId], references: [id])

  compania String?
  tarifa   String?

  pctCliente Decimal? @db.Decimal(5, 4)
  pctLugar   Decimal? @db.Decimal(5, 4)
  pctAgente  Decimal? @db.Decimal(5, 4)

  validFrom DateTime?
  validTo   DateTime?
  activo    Boolean   @default(true)
  prioridad Int       @default(0)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@index([lugarId, compania, tarifa, activo, validFrom, validTo])
  @@map("comision_override")
}

enum TipoOferta {
  LUZ
  GAS
  TELEFONIA
}

enum TipoCliente {
  RESIDENCIAL
  PYME
}

model OfertaTarifa {
  id               Int        @id @default(autoincrement())
  tipo             TipoOferta
  subtipo          String
  compania         String
  anexoPrecio      String?
  nombre           String
  descripcion      String?
  descripcionCorta String?
  activa           Boolean    @default(true)
  destacada        Boolean    @default(false)

  precioKwhP1 Decimal? @db.Decimal(10, 6)
  precioKwhP2 Decimal? @db.Decimal(10, 6)
  precioKwhP3 Decimal? @db.Decimal(10, 6)
  precioKwhP4 Decimal? @db.Decimal(10, 6)
  precioKwhP5 Decimal? @db.Decimal(10, 6)
  precioKwhP6 Decimal? @db.Decimal(10, 6)

  precioPotenciaP1 Decimal? @db.Decimal(10, 6)
  precioPotenciaP2 Decimal? @db.Decimal(10, 6)
  precioPotenciaP3 Decimal? @db.Decimal(10, 6)
  precioPotenciaP4 Decimal? @db.Decimal(10, 6)
  precioPotenciaP5 Decimal? @db.Decimal(10, 6)
  precioPotenciaP6 Decimal? @db.Decimal(10, 6)

  comisionKwhAdminBase Decimal? @db.Decimal(10, 6)
  payload              Json?

  referencia  String?
  tipoCliente TipoCliente?

  tramos  OfertaTarifaTramo[]
  ofertas Oferta[]            @relation("TarifaAOferta")

  solarConfigBase     OfertaTarifaSolarConfig?  @relation("SolarBase")
  solarConfigEspecial OfertaTarifaSolarConfig[] @relation("SolarEspecial")

  creadaEn      DateTime @default(now())
  actualizadaEn DateTime @updatedAt

  @@unique([tipo, subtipo, compania, nombre, anexoPrecio])
  @@index([tipo, subtipo, compania])
  @@index([tipo, subtipo, anexoPrecio])
}

model OfertaTarifaTramo {
  id             Int @id @default(autoincrement())
  ofertaTarifaId Int

  consumoDesdeKWh Int
  consumoHastaKWh Int?

  comisionKwhAdmin  Decimal? @db.Decimal(10, 6)
  comisionFijaAdmin Decimal? @db.Decimal(10, 2)

  pctCliente Decimal? @db.Decimal(5, 4)
  pctLugar   Decimal? @db.Decimal(5, 4)
  pctAgente  Decimal? @db.Decimal(5, 4)

  validFrom DateTime?
  validTo   DateTime?
  activo    Boolean   @default(true)
  notas     String?

  ofertaTarifa OfertaTarifa @relation(fields: [ofertaTarifaId], references: [id], onDelete: Cascade)

  @@unique([ofertaTarifaId, consumoDesdeKWh, consumoHastaKWh])
  @@index([ofertaTarifaId])
  @@index([consumoDesdeKWh, consumoHastaKWh])
}

model SolicitudContrato {
  id       Int      @id @default(autoincrement())
  creadaEn DateTime @default(now())
  estado   String   @default("PENDIENTE")

  tipoContratacion String?

  nombre              String
  apellidos           String?
  telefono            String
  email               String?
  dni                 String?
  direccionSuministro String?
  cups                String?
  iban                String?

  ofertaId     Int?
  compania     String?
  tarifa       String?
  agenteId     Int?
  lugarId      Int?
  tipoCliente  String?
  nombreTarifa String?

  archivos SolicitudContratoArchivo[]

  // ✅ MULTI-ADMIN (TENANT)
  adminId Int?
  admin   Usuario? @relation("AdminSolicitudes", fields: [adminId], references: [id])

  @@index([adminId])
}

model SolicitudContratoArchivo {
  id       Int      @id @default(autoincrement())
  creadaEn DateTime @default(now())

  solicitudId    Int
  url            String
  publicId       String?
  tipo           String?
  nombreOriginal String?
  mime           String?
  size           Int?

  solicitud SolicitudContrato @relation(fields: [solicitudId], references: [id], onDelete: Cascade)
}

enum TipoCompensacionExcedente {
  COMPENSACION
  BATERIA_VIRTUAL
  OTRO
}

enum LimiteCompensacionExcedente {
  ENERGIA
  TOTAL
}

model SolarExcedenteTarifa {
  id        Int                         @id @default(autoincrement())
  nombre    String
  compania  String?
  tipo      TipoCompensacionExcedente   @default(COMPENSACION)
  limite    LimiteCompensacionExcedente @default(ENERGIA)
  precioKwh Decimal?                    @db.Decimal(10, 6)
  payload   Json?

  activa        Boolean  @default(true)
  creadaEn      DateTime @default(now())
  actualizadaEn DateTime @updatedAt

  comparativas             Comparativa[]
  ofertaTarifaSolarConfigs OfertaTarifaSolarConfig[]

  @@index([activa, tipo])
  @@index([compania])
}

enum ModoSolarTarifa {
  MISMA_TARIFA
  TARIFA_SOLAR_ESPECIAL
}

model OfertaTarifaSolarConfig {
  id Int @id @default(autoincrement())

  ofertaTarifaBaseId Int
  ofertaTarifaBase   OfertaTarifa @relation("SolarBase", fields: [ofertaTarifaBaseId], references: [id], onDelete: Cascade)

  modo ModoSolarTarifa @default(MISMA_TARIFA)

  ofertaTarifaSolarId Int?
  ofertaTarifaSolar   OfertaTarifa? @relation("SolarEspecial", fields: [ofertaTarifaSolarId], references: [id])

  excedenteTarifaId Int?
  excedenteTarifa   SolarExcedenteTarifa? @relation(fields: [excedenteTarifaId], references: [id])

  activa Boolean @default(true)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([ofertaTarifaBaseId])
  @@index([modo, activa])
  @@index([excedenteTarifaId])
}

enum MarketingTipo {
  IMAGE
  VIDEO
  PDF
}

model MarketingAsset {
  id           Int           @id @default(autoincrement())
  tipo         MarketingTipo
  url          String
  nombre       String?
  publicId     String? // Cloudinary public_id
  resourceType String? // image | video | raw
  mime         String?
  size         Int?

  creadaEn DateTime @default(now())

  lugarId Int
  lugar   Lugar @relation(fields: [lugarId], references: [id], onDelete: Cascade)

  // Para trazabilidad multi-tenant:
  adminId  Int?
  agenteId Int?

  @@index([lugarId])
  @@index([adminId])
  @@index([agenteId])
  @@map("marketing_assets")
}

enum TipoCartelGenerado {
  A4_QR
  ESPECIAL
}

enum AccionCartelGenerado {
  IMPRIMIR
  DESCARGAR_PDF
  DESCARGAR_PNG
}

model CartelGenerado {
  id       Int      @id @default(autoincrement())
  creadoEn DateTime @default(now())

  tipo   TipoCartelGenerado
  accion AccionCartelGenerado

  lugarId Int
  lugar   Lugar @relation("LugarCartelesGenerados", fields: [lugarId], references: [id], onDelete: Cascade)

  fondoId Int?
  fondo   Fondo? @relation("FondoCartelesGenerados", fields: [fondoId], references: [id], onDelete: SetNull)

  fondoUrlSnap String?
  qrUrlSnap    String?

  creadoPorId Int?
  creadoPor   Usuario? @relation("UsuarioCartelesCreados", fields: [creadoPorId], references: [id], onDelete: SetNull)

  adminId Int?
  admin   Usuario? @relation("AdminCartelesGenerados", fields: [adminId], references: [id])

  // ✅ Archivo generado (PDF / PNG)
  archivoUrl          String?
  archivoPublicId     String?
  archivoResourceType String? // raw | image
  archivoMime         String?
  archivoBytes        Int?
  archivoFormat       String?

  @@index([lugarId, creadoEn])
  @@index([tipo, accion, creadoEn])
  @@index([adminId])
  @@map("carteles_generados")
}

model LeadActividad {
  id       Int      @id @default(autoincrement())
  creadoEn DateTime @default(now())

  tipo    String
  titulo  String
  detalle String?

  leadId Int
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // quién creó la actividad (usuario logueado)
  usuarioId Int?
  usuario   Usuario? @relation("UsuarioLeadActividades", fields: [usuarioId], references: [id])

  // tenant / admin propietario
  adminId Int?
  admin   Usuario? @relation("AdminLeadActividades", fields: [adminId], references: [id])

  @@index([leadId, creadoEn])
  @@index([adminId])
}

model PlantillaMensaje {
  id            Int      @id @default(autoincrement())
  creadaEn      DateTime @default(now())
  actualizadaEn DateTime @updatedAt

  adminId Int?
  admin   Usuario? @relation("PlantillaMensajeAdmin", fields: [adminId], references: [id], onDelete: SetNull)

  canal    String  @default("whatsapp")
  etapa    String
  variante String  @default("A")
  activa   Boolean @default(true)

  titulo          String
  contenido       String
  plantillaEnvios PlantillaEnvio[]

  @@index([adminId, canal, etapa, variante])
}

model PlantillaEnvio {
  id       Int      @id @default(autoincrement())
  creadoEn DateTime @default(now())

  canal    String
  etapa    String
  variante String // "A" | "B"

  leadId Int
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  plantillaId Int?
  plantilla   PlantillaMensaje? @relation(fields: [plantillaId], references: [id], onDelete: SetNull)

  adminId Int?
  admin   Usuario? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  usuarioId Int?
  usuario   Usuario? @relation("PlantillaEnvioUsuario", fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([adminId, creadoEn])
  @@index([leadId, creadoEn])
  @@index([etapa, variante, creadoEn])
}

enum CanalEnvioDocumento {
  WHATSAPP
  EMAIL
  OTRO
}

model LeadDocumento {
  id       Int      @id @default(autoincrement())
  creadoEn DateTime @default(now())

  leadId Int
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // archivo
  nombre       String
  url          String
  publicId     String?
  resourceType String? // raw | image | video
  mime         String?
  size         Int?

  // trazabilidad
  creadoPorId Int?
  creadoPor   Usuario? @relation("LeadDocumentoCreadoPor", fields: [creadoPorId], references: [id], onDelete: SetNull)

  adminId Int?
  admin   Usuario? @relation("LeadDocumentoAdmin", fields: [adminId], references: [id], onDelete: SetNull)


  @@index([leadId, creadoEn])
  @@index([adminId, creadoEn])
}
